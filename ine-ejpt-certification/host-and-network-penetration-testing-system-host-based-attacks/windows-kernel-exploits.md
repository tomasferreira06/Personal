# Windows Kernel Exploits

* Privilege escalation is the process of exploiting vulnerabilities or miconfigurations in systems to elevate privileges from one user to another, typically to a user with admin or root access
* PrivEsc is a vital element of the attack life cycle and is a major determinant in the overall success of a penetration test.
* After gaining an initial foothold on a target system you will be required to eleveate your privileges in order to perform tasks and functionality that require administrative privileges.

## Windows Kernel

* Kernel is a computer program that is the core of an OS and had compelte control over every resuorce and hardware.
* Layer between hardware and software
* Windows NT is the kernet that comes pre-packaged with all version of Microsoft Windows and operates as a traditional kernel.
* Consists of:
  * User Mode - Programs and services running in user mode have limited access to system resources and hardware:
  * Kernel Mode - Kernel mode has unrestricted access to system resources and fucntionality with the addeed functionality of managing devices and system memory.

## Windows Kernel Exploitation

* Kernel exploits on Windows will typically target vulnerabilities In the Windows kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell.

Privilege escalation on Windows systems will typically follow the following methodology:

* Identifying kernel vulnerabilities
* Downloading, compiling and transferring kernel exploits onto the target system.

## Tools & Environments

*   <mark style="color:blue;">Windows-Exploit-Suggester</mark> - This tool compares a targets patch levels against the Microsoft vulnerability database in order to detect potential missing patches on the target. It also notifies the user if there are public exploits and Metasploit modules available for the missing bulletins.

    * <mark style="color:red;">GitHub:</mark> https://github.com/AonCyberLabs/Windows-Exploit-Suggester&#x20;


*   <mark style="color:blue;">Windows-Kernel-Exploits</mark> - Collection of Windows Kernel exploits sorted by CVE.

    * <mark style="color:red;">GitHub:</mark> https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16- 135&#x20;

    <mark style="color:purple;">NOTE:</mark> The techniques demonstrated in this video are performed on a Windows 7 SP1 VM.-

## Practice Demo

You can use the command <mark style="color:red;">getsystem</mark> to escalate your privilieges automatically inside a meterpreter session.

#### Module used:

* <mark style="color:yellow;">exploit/windows/local/ms16\_014\_wmi\_recv\_notif</mark>

Make sure to adjust the LPORT to be different from existing sessions

### Manual Exploitation

Tools used are referenced above in the <mark style="color:red;">Tools & Environments</mark> section.

Clone the repository

Follow the steps

#### Running the suggester

<mark style="color:purple;">NOTE</mark>: You need to run <mark style="color:orange;">sysinfo</mark> command inside the target and paste the output into a file to run the <mark style="color:red;">Windows-Kernel-Suggester</mark> tool.

Run:

* <mark style="color:yellow;">./windows-exploit-suggester.py --update</mark>: Updates the vulnerability database for the script
* <mark style="color:yellow;">./windows-exploit-suggester.py --database nameofdatabase.xls sysinfofile</mark>
  * When the <mark style="color:yellow;">--update</mark> flag is ran it creates a database file with the current date

<mark style="color:purple;">NOTE:</mark> In the output <mark style="color:red;">\[E]</mark> means a POC exploit, and an <mark style="color:red;">\[M]</mark> means metasploit module.

#### Exploiting MS16-135

[https://github.com/SecWiki/windows-kernel-exploits](https://github.com/SecWiki/windows-kernel-exploits)

Download the prebuilt binary ".exe" or compile the C code.

Use the meterpreter session to upload the malicious script into the "<mark style="color:red;">temp</mark>" directory on the target.
