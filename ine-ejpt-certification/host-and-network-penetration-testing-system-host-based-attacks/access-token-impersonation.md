# Access Token Impersonation

## Windows Access Tokens

* Windows access tokens are a core element of the authentication process on Windows&#x20;
* Created and managed by <mark style="color:red;">LSASS</mark> (Local Seucirty Authority Subsytem Service)
* An access token is responsible for identifying and describing the security context of a process or trhread running on a system.
* Simply, it can be thought as a temporary key similar to a web cookie that provides users with access to a system network resource without having to provide credentials each time a process is started or a system resource is accessed.
* Access tokens are generated by the <mark style="color:red;">winlogon.exe</mark> process every time a user authenticates successfully and includes the identify and privileges of the user accout associated with the thread or process. It is then attached to the <mark style="color:red;">userinit.exe</mark> process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.

Windows access tokens are categorized based on the varying security elvels assigned to them.

Security levels are used to determine the privileges that are assigned to a specific token.

#### Security levels:

* <mark style="color:red;">Impersonate-level tokens</mark> are created as a direct result of a non-interactive login on Windows, typically through specific system services or domain logons.&#x20;
* <mark style="color:red;">Impersonate-level tokens</mark> can be used to impersonate a token on the local system and not on any external systems that utilize the token.&#x20;
* <mark style="color:red;">Delegate-level tokens</mark> are typically created through an interactive login on Windows, primarily through a traditional login or through remote access protocols such as RDP.&#x20;
* <mark style="color:red;">Delegate-level tokens</mark> pose the largest threat as they can be used to impersonate tokens on any system.-&#x20;

## Windows Privileges

* The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonation or delegation tokens available.&#x20;
* The following are the privileges that are required for a successful impersonation attack:&#x20;
  * <mark style="color:blue;">SeAssignPrimaryToken</mark>: This allows a user to impersonate tokens.&#x20;
  * <mark style="color:blue;">SeCreateToken</mark>: This allows a user to create an arbitrary token with administrative privileges.&#x20;
  * <mark style="color:blue;">SeImpersonatePrivilege</mark>: This allows a user to create a process under the security context of another user typically with administrative privileges.

### The Incognito Module

* <mark style="color:red;">Incognito</mark> is a built-in meterpreter module that was originally a standalone application that allows you to impersonate user tokens after successful exploitation.&#x20;
* We can use the incognito module to display a list of available tokens that we can impersonate.

## Practice Demo

Obtain initial access to the target

In this case we used again the "rejetto\_http\_file\_server" module.

#### Load Incognito

* <mark style="color:yellow;">load incognito</mark>

#### List  User account tokens

* <mark style="color:yellow;">list\_tokens -u</mark>

#### Impersonate Access token

* <mark style="color:yellow;">impersonate\_token NAMEOFTOKEN</mark>

<mark style="color:purple;">NOTE:</mark> To execute <mark style="color:yellow;">getprivs</mark> you need to be in a <mark style="color:blue;">64-bit</mark> meterpreter session.

After impersonating the <mark style="color:red;">Administrator</mark> access token, we gain access to more access tokens for example <mark style="color:red;">NT AUTHORITY\SYSTEM</mark>

If after initial access we dont have any delegation Tokens available, we have to execute a <mark style="color:green;">potato</mark> attack, which will generate an <mark style="color:red;">NT AUTHORITY\SYSTEM</mark> and then you can impersonate it.
