# Dumping & Cracking NTLM Hashes

## Windows Password Hashes

* The Windows OS stores <mark style="color:red;">hashed user accounts passwords</mark> locally in the <mark style="color:red;">SAM (Security Accounts Manager)</mark> database.
* Hashing is the process of converting a piece of data into another value. A hashing function or algorithm is used to generate the new value. The result of a hashing algorithm is known as a hash r has value.
* <mark style="color:red;">Authentication and verification</mark> of user credentials is facilitated by the <mark style="color:red;">Local Security Authority (LSA)</mark>.
* Windows versions up to Windows Server 2003 utilize two different types of hashses:
  * <mark style="color:red;">LM</mark>
  * <mark style="color:red;">NTLM</mark>
* <mark style="color:blue;">Windows disables LM hashing and utilies NTLM hashing from Windows Vista onwards.</mark>

## SAM Database

* SAM (Security Accounts Manager) is a database file that is responsible for managing user accounts and password on Windows. All user account passwords stored in the SAM databse are hashed.
* The SAM database file cannot be copied while the OS is running.
* The Windows NT kernel keeps the SAM database file locked and as a result, attacker typically utilize in memory techniques and tools to dump SAM hashes from the LSASS process.
* In modern versions of Windows, the SAM database is encrypted with a syskey. (Only up to Windows 10)

<mark style="color:purple;">NOTE:</mark> Elevated/Administrative privileges are required in order to access and interact with the LSASS process.&#x20;

## NTLM (NTHash)

NTLM is a collection of authentication protocols that are utilized in Windows to facilitate authentication between computers. The authentication process involves using a valid username and password to authenticate sucessfully.

From Windows Vista onwards, Windows disables LM hashing and utilizes NTLM hashing.

When a user account is created, it is encrypted using the MD4 hashing algorithm, while the original password is disposed of.

#### NTLM improves upon LM in the following ways:

* Does not split the hash in to two chunks.
* Case sensitive
* Allows the use of symbols and unicode characters.

<figure><img src="../../.gitbook/assets/image (165).png" alt=""><figcaption></figcaption></figure>

## Dumping & Cracking NTLM Hashes

* We can dump Windows password hashes by leveraging various utilities like:
  * The inbuilt meterpreter "<mark style="color:red;">hashdump</mark>" command
  * Mimikatz
* After we have dumped the hashes, we can crack them through the use of the following utilities:
  * <mark style="color:red;">John The Ripper</mark>
  * <mark style="color:red;">Hashcat</mark>

## Practice Demo

Enumerate the target.

In this case we identify the <mark style="color:red;">BadBlue Web server</mark> running.

Exploit it with metasploit module.

We get a 32 bit meterpreter session as the admin user.

Before dumping the hashes, migrate to a more stable service, for example <mark style="color:blue;">LSASS</mark>.&#x20;

#### Dumping the NTLM Hashes

In meterpreter run

* <mark style="color:yellow;">hashdump</mark>

<figure><img src="../../.gitbook/assets/image (114).png" alt=""><figcaption></figcaption></figure>

Copy the hashes (WITH THE USERNAME...THE WHOLE OUTPUT) and paste them into a file.

#### Cracking NTLM hashes with John the Ripper

* <mark style="color:yellow;">john --format=NT  'filewithhashes'</mark>

If you don't specify a password list it will use the default john the rippers list.

#### Using a wordlist

* <mark style="color:yellow;">john --format=NT hashes.txt --wordlist=/usr/share/wordlists/rockyou.txt</mark>

#### Cracking hashes with Hashcat

In the case of Hashcat, when specifying the <mark style="color:red;">hash-type</mark> you need to specify the <mark style="color:red;">Hash ID</mark> (which can be found in the help page).

<mark style="color:blue;">When using hackcat see the help first.</mark>

* <mark style="color:yellow;">hashcat -a3 -m 1000 hashes.txt /usr/share/wordlists/rockyou.txt</mark>
